# 操作系统

## 特征

- 并发
- 共享：资源共享
- 虚拟：把物理上的实体变为若干个逻辑上的对应物，使用"时分复用技术"
- 异步：允许多个程序并发执行，进程走走停停，不可预知的速度向前

> 并发：多个程序都处于运行状态，并且他们都是在同一个处理机上执行
> 并行：当系统有一个以上CPU时(或者一个CPU有多个核心)，两个进程不互相抢占CPU资源，可以同时运行

## 中断

中断可以使CPU从用户态切换为核心态，使操作系统获得计算机的控制权。

有了中断才能让程序并发执行。

## 进程

每创建一个进程，系统会分配4G虚拟内存，包括3G用户内存和1G内核内存。

内核内存对所有进程共享，所以绝大多数进程间通信的本质都是对内核空间的操作。

五种状态：

- 创建态
- 就绪态
- 运行态
- 阻塞态
- 终止态

使用PCB管理进程，PCB里记录了改进程的状态、比如程序指针、变量指针和状态标志等等。

用原语控制进程，即原子操作，执行期间不允许中断。采用关中断和开中断指令实现。

进程拥有的内存地址相互独立。一个进程不能访问另一个进程的内存地址。

进程通信：

- 共享内存：进程访问必须互斥
- 管道通信：其实就是在内存中开辟一个大小固定的缓冲区，管道只能半双工通信，所以需要两个管道，写满时不能写，读空时不能读
- 消息传递：发送格式化消息，直接挂到接收方消息队列，或者发送到中间体（信箱）

具体方式：

- 管道：有名管道，无名管道
- 信号：本质是中断
- 消息队列
- 共享内存：效率最高，直接操作物理内存
- 信号量：本质是一个非负的整数计数器，用来控制对公共资源的访问，当信号量大于0，可以访问，否则阻塞
- socket

## 信号

信号是软件层次上的中断机制，是一种异步通信。通过发送信号（应该是改变内核内存中的变量）操作进程，比如停止。

发送信号的函数：

- kill：给指定进程立即发送信号
- alarm：在一段时间后发送信号
- raise：给本进程立即发送信号
- 信号集等

## 管道

又称无名管道，是在内核空间创建的一种特殊类型的文件，多个进程共享。在应用层表示为两个文件描述符，一个负责读，一个负责写。

由于无名管道创建之后给当前进程两个文件描述符，如果是完全不相关的进程，无法获取同一个无名管道。

只能在父进程创建无名管道，然后再创建子进程，两者通过读写无名管道实现通信。即具有亲缘关系的进程使用。

写满时再写会阻塞，读空时再读也会阻塞，默认64K字节。

读完一次会清除读取过的数据。

## 有名管道

和管道基本相同，不同点：

- 写入数据先入先出FIFO
- 有名管道存在于文件系统中，不相关的进程可以通过打开命名管道进行通信
- 有名管道创建的本地文件只起到标识作用，对管道的操作本质还是对内核空间的操作

## IPC对象

分为消息队列、共享内存和信号灯集。

IPC对象也是在内核空间开辟区域，每一种IPC对象创建好后都会将其设置为全局，并分配一个编号，只要找到编号就可以通过IPC通信。

### 消息队列

消息队列是消息的链表，存放在内存中，由内核维护。

每个消息队列都有唯一标志符。

只有内核重启或者人工删除队列时，才会被删除。

通过 `ftok` 函数可以获得一个key值，通过key值就可以在系统中获得唯一标识符。

### 共享内存

允许多个进程共享给定的区域。

是进程间通信最快的方法，原因是直接操作物理内存，其他的方式都是操作虚拟内存。

要注意内存区域对各个进程是互斥的。

## 线程

有的进程需要"同时"做很多事，所以引入了线程，作为执行流的最小单位。

实现方式：

用户级线程，由应用程序通过线程库实现。

内核级线程，由操作系统内核完成。

在同时支持用户级线程和内核级线程的系统中，可采用二者组合方式，将n个用户线程映射到m个内核级线程上。

### 单标志法

使用一个标志位用于判断是否能使用临界区

### 双标志先检查

设置布尔型数组，每个进程对应一个元素， 各进程想进入临界区之前先将自己的标志位置为true，访问完后再置为false。

### 双标志后检查

### Peterson算法

结合双标志位和单标志位，即数组和一个标志位。

## 信号量机制

整型信号量、记录型信号量

信号量就是一个变量，表示系统中某种资源的数量。可以用整数，也可以用结构体。

## 生产者消费者

生产者生成的数据放入缓冲区，消费者从中取出。

缓冲区时临界资源，必须互斥的访问。

## 管程

一种高级同步机制，比信号量更高级。更方便的实现进程互斥和同步。

Java中的synchronized就是管程机制。

## 死锁

在并发环境下，各进程因竞争资源而造成的一种互相等待对方手里的资源，导致各进程都在阻塞的现象。

## 内存管理

1. 内存空间的分配于回收
2. 虚拟内存
3. 地址转换
4. 内存保护

覆盖技术，解决程序大小超过物理呢村总和的问题。将程序分为多个段，常用的段常驻内存，不常用的段再需要时调入内存。

分为一个固定区和若干个覆盖区。

交换技术：内存空间紧张时，将内存中某些进程暂时换出外存，把已经具备运行条件的进程换入内存。

**动态分区分配**

根据进程的大小动态的简历分区，并使分区的大小正好适合进程的需要。

分配算法：

- 首次适应
- 最佳适应
- 最坏适应
- 邻近适应

**非连续分配管理方式**

- 基本分页存储管理：把内存分为一个个相等的小分区，再按照分区把进程拆分成小部分
- 基本分段存储管理
- 段页式存储管理

## 文件

- 无结构文件：文本文件
- 有结构文件：顺序文件、索引文件、索引数序文件
